<div class="min-h-screen bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-100" *ngIf="trip">
  <app-navbar [currentPage]="'journals'"></app-navbar>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-[240px_1fr] gap-8 xl:gap-16">
      <aside class="hidden lg:block relative">
        <div class="sticky top-24 space-y-8">
          <div class="flex flex-col gap-2 p-4 bg-surface-light dark:bg-surface-dark rounded-xl border border-slate-200 dark:border-slate-800/50 shadow-sm max-h-[calc(100vh-360px)] overflow-hidden">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex-shrink-0">{{ 'trip.tableOfContents' | translate }}</h2>
            <nav class="flex flex-col gap-1 overflow-y-auto pr-1 thin-scrollbar">
              <button (click)="scrollToSection('intro')" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/10 text-primary font-medium text-sm transition-colors text-left w-full flex-shrink-0">
                <span class="material-symbols-outlined text-[18px] flex-shrink-0">info</span>
                <span>{{ 'trip.intro' | translate }}</span>
              </button>
              @for (entry of entries; track entry.entryId; let i = $index) {
                <button (click)="scrollToSection('entry-' + i)" class="flex items-start gap-3 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 text-sm font-medium transition-colors text-left w-full">
                  <span class="w-1.5 h-1.5 rounded-full bg-slate-300 dark:bg-slate-600 flex-shrink-0 mt-1.5"></span>
                  <span class="break-words line-clamp-2">{{ 'trip.day' | translate }} {{ entry.dayNumber }}: {{ entry.title }}</span>
                </button>
              }
            </nav>
          </div>

          <div class="bg-surface-light dark:bg-surface-dark rounded-xl p-5 border border-slate-200 dark:border-slate-800/50 shadow-sm flex flex-col gap-4">
            <h3 class="text-sm font-semibold text-slate-900 dark:text-white">{{ 'trip.stats.title' | translate }}</h3>
            <div class="grid grid-cols-2 gap-4">
              <div class="flex flex-col">
                <span class="text-xs text-slate-500">{{ 'trip.stats.duration' | translate }}</span>
                <span class="text-sm font-medium text-slate-800 dark:text-slate-200">{{ getTripDuration() }} {{ 'trip.stats.days' | translate }}</span>
              </div>
              <div class="flex flex-col">
                <span class="text-xs text-slate-500">{{ 'trip.stats.entries' | translate }}</span>
                <span class="text-sm font-medium text-slate-800 dark:text-slate-200">{{ entries.length }}</span>
              </div>
              <div class="flex flex-col">
                <span class="text-xs text-slate-500">{{ 'trip.stats.photos' | translate }}</span>
                <span class="text-sm font-medium text-slate-800 dark:text-slate-200">{{ getTotalPhotos() }}</span>
              </div>
              <div class="flex flex-col">
                <span class="text-xs text-slate-500">{{ 'trip.stats.location' | translate }}</span>
                <span class="text-sm font-medium text-slate-800 dark:text-slate-200">{{ trip.location }}</span>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <main class="flex flex-col gap-12 max-w-4xl">
        <div id="intro" class="group relative w-full h-[500px] rounded-2xl overflow-hidden shadow-md">
          <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" [style.backgroundImage]="getCoverImage(trip.coverPhotoUrl)"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div>
          <div class="absolute bottom-0 left-0 w-full p-6 md:p-10 flex flex-col gap-4">
            <div class="flex items-center gap-3 text-primary font-medium text-sm tracking-wide uppercase">
              <span class="bg-primary/20 backdrop-blur-sm px-3 py-1 rounded-full text-primary border border-primary/30">{{ trip.title }}</span>
              <span class="text-white/80 flex items-center gap-1">
                <span class="material-symbols-outlined text-[16px]">calendar_today</span>
                {{ formatDateRange(trip.startDate, trip.endDate) }}
              </span>
            </div>
            <h1 class="text-3xl md:text-5xl font-bold text-white leading-tight">{{ trip.title }}</h1>
            <div class="flex items-center gap-2 text-white/90 text-sm md:text-base mt-2">
              <span class="material-symbols-outlined text-primary">location_on</span>
              {{ trip.location }}
            </div>
          </div>
        </div>

        <div *ngIf="isLoading" class="flex items-center justify-center py-12">
          <span class="material-symbols-outlined text-4xl text-primary animate-spin">progress_activity</span>
        </div>

        <div *ngIf="!isLoading && entries.length === 0" class="bg-surface-light dark:bg-surface-dark p-8 rounded-2xl border border-slate-200 dark:border-slate-800/50 shadow-sm text-center">
          <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4">
            <span class="material-symbols-outlined text-3xl text-primary">edit_note</span>
          </div>
          <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">{{ 'trip.noEntries' | translate }}</h3>
          <p class="text-slate-500 dark:text-slate-400 mb-6">{{ 'trip.startDocumenting' | translate }}</p>
          <a
            [routerLink]="['/trips', trip.tripId, 'add-entry']"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-primary text-surface-dark font-bold hover:shadow-lg hover:shadow-primary/20 transition-all"
          >
            <span class="material-symbols-outlined">add</span>
            {{ 'trip.addEntry' | translate }}
          </a>
        </div>

        <div class="relative pl-0 md:pl-8" *ngIf="entries.length > 0">
          <div class="hidden md:block absolute left-[41px] top-4 bottom-0 w-0.5 bg-slate-200 dark:bg-slate-700"></div>

          @for (entry of entries; track entry.entryId; let i = $index) {
            <div [id]="'entry-' + i" class="relative pb-16 pl-0 md:pl-10 group">
              <div class="hidden md:flex absolute left-0 top-2 size-5 bg-background-light dark:bg-background-dark border-4 border-primary rounded-full z-10 shadow-sm group-hover:scale-125 transition-transform"></div>

              <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-6 gap-2">
                <div>
                  <h2 class="text-2xl font-bold text-slate-900 dark:text-white flex items-center gap-3">
                    {{ 'trip.day' | translate }} {{ entry.dayNumber }}: {{ entry.title }}
                  </h2>
                  <span *ngIf="entry.locationLabel" class="text-slate-500 text-sm font-medium mt-1 flex items-center gap-1">
                    <span class="material-symbols-outlined text-[16px]">location_on</span>
                    {{ entry.locationLabel }}
                  </span>
                </div>
                <div class="flex gap-2">
                  <button (click)="shareEntry(entry)" class="p-2 text-slate-400 hover:text-primary transition-colors" [title]="'trip.actions.share' | translate">
                    <span class="material-symbols-outlined">share</span>
                  </button>
                  <button (click)="openEditModal(entry)" class="p-2 text-slate-400 hover:text-primary transition-colors" [title]="'trip.actions.edit' | translate">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button (click)="confirmDeleteEntry(entry.entryId)" class="p-2 text-slate-400 hover:text-red-500 transition-colors" [title]="'trip.actions.delete' | translate">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </div>

              <div
                class="prose dark:prose-invert max-w-none text-slate-600 dark:text-slate-300 mb-6
                break-words [overflow-wrap:anywhere] [word-break:break-word]
                [&_ul]:list-disc [&_ul]:pl-6 [&_ul]:my-2
                [&_ol]:list-decimal [&_ol]:pl-6 [&_ol]:my-2
                [&_li]:my-1
                [&_blockquote]:border-l-4 [&_blockquote]:border-primary [&_blockquote]:pl-4 [&_blockquote]:italic [&_blockquote]:text-slate-500 [&_blockquote]:dark:text-slate-400 [&_blockquote]:my-4
                [&_b]:font-bold [&_strong]:font-bold
                [&_i]:italic [&_em]:italic
                [&_u]:underline
                [&_*]:break-words [&_*]:[overflow-wrap:anywhere]"
                [innerHTML]="entry.content"
              ></div>

              <div *ngIf="entry.photos && entry.photos.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                @for (photo of entry.photos; track photo.photoUrl; let j = $index) {
                  <div
                    class="aspect-square rounded-lg overflow-hidden relative group/img cursor-pointer"
                    (click)="openLightbox(photo.photoUrl)"
                  >
                    <img [src]="formatUrl(photo.photoUrl)" [alt]="'Photo ' + (j + 1)" class="w-full h-full object-cover transition-transform duration-500 group-hover/img:scale-110" loading="lazy" />
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover/img:opacity-100 transition-opacity">
                      <span class="material-symbols-outlined text-white text-2xl">zoom_in</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>

        <div class="border-t border-slate-200 dark:border-slate-800 pt-12 pb-24">
          <div class="flex items-center justify-between">
            <a
              routerLink="/dashboard"
              class="px-6 py-3 bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white rounded-xl font-medium hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
            >
              {{ 'trip.backToJournals' | translate }}
            </a>
          </div>
        </div>
      </main>
    </div>
  </div>

  <a
    [routerLink]="['/trips', trip.tripId, 'add-entry']"
    aria-label="Add entry"
    class="fixed bottom-8 right-8 z-50 bg-primary text-surface-dark p-4 rounded-full shadow-lg hover:shadow-primary/50 hover:scale-105 transition-all flex items-center justify-center group"
  >
    <span class="material-symbols-outlined text-2xl group-hover:rotate-90 transition-transform">add</span>
  </a>

  <app-toast></app-toast>

  <app-confirm-modal
    [isOpen]="showDeleteModal"
    [isLoading]="isDeleting"
    [title]="'trip.deleteEntry.title' | translate"
    [message]="'trip.deleteEntry.message' | translate"
    [confirmText]="'trip.deleteEntry.confirm' | translate"
    [cancelText]="'trip.deleteEntry.cancel' | translate"
    type="danger"
    (confirmed)="deleteEntry()"
    (cancelled)="cancelDelete()"
  ></app-confirm-modal>
</div>

<div *ngIf="selectedImage" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" (click)="closeLightbox()">
  <button class="absolute top-6 right-6 text-white hover:text-primary transition-colors" (click)="closeLightbox()">
    <span class="material-symbols-outlined text-3xl">close</span>
  </button>
  <img [src]="selectedImage" [alt]="'trip.photo.fullSize' | translate" class="max-w-full max-h-full object-contain rounded-lg" (click)="$event.stopPropagation()" />
</div>

<div *ngIf="showEditModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" (click)="closeEditModal()">
  <div class="bg-white dark:bg-surface-dark rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col animate-fade-in" (click)="$event.stopPropagation()">
    <div class="flex items-center justify-between p-6 border-b border-slate-200 dark:border-slate-700 flex-shrink-0">
      <h3 class="text-xl font-bold text-slate-900 dark:text-white">{{ 'trip.editEntry.title' | translate }}</h3>
      <button (click)="closeEditModal()" class="p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <div class="p-6 overflow-y-auto flex-1 thin-scrollbar">
      <div class="space-y-5">
        <div class="flex gap-4">
          <div class="w-24">
            <label class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block">{{ 'trip.editEntry.day' | translate }}</label>
            <input
              [(ngModel)]="editForm.dayNumber"
              type="number"
              min="1"
              class="w-full px-3 py-2.5 bg-background-light dark:bg-background-dark border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
            />
          </div>
          <div class="flex-1">
            <label class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block">{{ 'trip.editEntry.entryTitle' | translate }}</label>
            <input
              [(ngModel)]="editForm.title"
              type="text"
              class="w-full px-3 py-2.5 bg-background-light dark:bg-background-dark border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
            />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block">{{ 'trip.editEntry.location' | translate }}</label>
          <div class="relative">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[20px]">location_on</span>
            <input
              [(ngModel)]="editForm.locationLabel"
              type="text"
              class="w-full px-3 py-2.5 pl-10 bg-background-light dark:bg-background-dark border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all"
            />
          </div>
        </div>

        <div>
          <label class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-1.5 block">{{ 'trip.editEntry.content' | translate }}</label>
          <div class="rounded-xl border border-slate-200 dark:border-slate-700 bg-background-light dark:bg-background-dark overflow-hidden focus-within:border-primary focus-within:ring-1 focus-within:ring-primary transition-all">
            <div class="flex items-center gap-1 p-2 border-b border-slate-100 dark:border-slate-700/50 bg-slate-50/50 dark:bg-black/20">
              <button
                type="button"
                (click)="toggleEditBold()"
                class="flex items-center justify-center p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                [ngClass]="{'bg-slate-200 dark:bg-slate-600 text-primary': isEditBold, 'text-slate-500': !isEditBold}"
                [title]="'trip.formatting.bold' | translate"
              >
                <span class="material-symbols-outlined text-[18px]">format_bold</span>
              </button>
              <button
                type="button"
                (click)="toggleEditItalic()"
                class="flex items-center justify-center p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                [ngClass]="{'bg-slate-200 dark:bg-slate-600 text-primary': isEditItalic, 'text-slate-500': !isEditItalic}"
                [title]="'trip.formatting.italic' | translate"
              >
                <span class="material-symbols-outlined text-[18px]">format_italic</span>
              </button>
              <button
                type="button"
                (click)="toggleEditUnderline()"
                class="flex items-center justify-center p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                [ngClass]="{'bg-slate-200 dark:bg-slate-600 text-primary': isEditUnderline, 'text-slate-500': !isEditUnderline}"
                [title]="'trip.formatting.underline' | translate"
              >
                <span class="material-symbols-outlined text-[18px]">format_underlined</span>
              </button>
              <div class="w-px h-4 bg-slate-300 dark:bg-slate-600 mx-1"></div>
              <button
                type="button"
                (click)="toggleEditBulletList()"
                class="flex items-center justify-center p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                [ngClass]="{'bg-slate-200 dark:bg-slate-600 text-primary': isEditList, 'text-slate-500': !isEditList}"
                [title]="'trip.formatting.bulletList' | translate"
              >
                <span class="material-symbols-outlined text-[18px]">format_list_bulleted</span>
              </button>
              <button
                type="button"
                (click)="toggleEditQuote()"
                class="flex items-center justify-center p-1.5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                [ngClass]="{'bg-slate-200 dark:bg-slate-600 text-primary': isEditQuote, 'text-slate-500': !isEditQuote}"
                [title]="'trip.formatting.quote' | translate"
              >
                <span class="material-symbols-outlined text-[18px]">format_quote</span>
              </button>
            </div>
            <div
              #editContentEditor
              contenteditable="true"
              (input)="onEditContentChange()"
              (blur)="onEditContentChange()"
              class="w-full min-h-[150px] max-h-[200px] overflow-y-auto p-4 text-slate-900 dark:text-white leading-relaxed text-sm focus:outline-none prose prose-sm prose-slate dark:prose-invert max-w-none
              [&_ul]:list-disc [&_ul]:pl-5 [&_ul]:my-2
              [&_ol]:list-decimal [&_ol]:pl-5 [&_ol]:my-2
              [&_li]:my-1
              [&_blockquote]:border-l-4 [&_blockquote]:border-primary [&_blockquote]:pl-3 [&_blockquote]:italic [&_blockquote]:text-slate-500 [&_blockquote]:dark:text-slate-400 [&_blockquote]:my-3"
            ></div>
          </div>
        </div>

        <div *ngIf="editingEntry?.photos && editingEntry!.photos!.length > 0">
          <label class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-3 block">{{ 'trip.editEntry.photos' | translate }}</label>
          <div class="grid grid-cols-3 sm:grid-cols-4 gap-3">
            @for (photo of editingEntry!.photos!; track photo.photoUrl; let idx = $index) {
              <div
                (click)="markPhotoForDeletion(photo.photoUrl)"
                class="relative aspect-square rounded-lg overflow-hidden cursor-pointer group"
                [ngClass]="{'ring-2 ring-red-500 opacity-50': isPhotoMarkedForDeletion(photo.photoUrl)}"
              >
                <img [src]="formatUrl(photo.photoUrl)" class="w-full h-full object-cover" />
                <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                  <span class="material-symbols-outlined text-white" [ngClass]="{'text-red-400': isPhotoMarkedForDeletion(photo.photoUrl)}">
                    {{ isPhotoMarkedForDeletion(photo.photoUrl) ? 'restore' : 'delete' }}
                  </span>
                </div>
                <div *ngIf="isPhotoMarkedForDeletion(photo.photoUrl)" class="flex items-center justify-center absolute top-1 right-1 bg-red-500 text-white rounded-full p-0.5">
                  <span class="material-symbols-outlined text-[14px]">close</span>
                </div>
              </div>
            }
          </div>
          <p *ngIf="photosToDelete.length > 0" class="text-sm text-red-500 mt-2">
            {{ 'trip.editEntry.photosToDelete' | translate: { count: photosToDelete.length } }}
          </p>
        </div>
      </div>
    </div>

    <div class="flex justify-end gap-3 p-6 border-t border-slate-200 dark:border-slate-700 flex-shrink-0">
      <button
        (click)="closeEditModal()"
        [disabled]="isUpdating"
        class="px-5 py-2.5 rounded-xl text-slate-600 dark:text-slate-300 font-medium hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
      >
        {{ 'trip.editEntry.cancel' | translate }}
      </button>
      <button
        (click)="saveEntry()"
        [disabled]="isUpdating"
        class="px-5 py-2.5 rounded-xl bg-primary text-surface-dark font-bold hover:brightness-105 transition-all flex items-center gap-2 disabled:opacity-50"
      >
        <span class="material-symbols-outlined text-[18px]">{{ isUpdating ? 'progress_activity' : 'save' }}</span>
        {{ isUpdating ? ('trip.editEntry.saving' | translate) : ('trip.editEntry.saveChanges' | translate) }}
      </button>
    </div>
  </div>
</div>
